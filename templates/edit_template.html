{% extends "base.html" %}

{% block sidebar %}
    {% include 'sidebar.html' %}
{% endblock %}

{% block head %}
    <style>
        .variable-button {
            margin-right: 5px;
            display: inline-block;
        }
        .cke_button__insertvariable_label {
            background-color: green !important;
            color: #fff !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col">
            <h2>Edit Template: {{ template_name }}</h2>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="mt-4">
                {% for message in messages %}
                <div class="alert alert-warning" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            
            <!-- This is the div where flash messages from AJAX operations will go -->
            <div id="flash-messages"></div>
          
            <!-- Detailed editing view -->
            <div id="template-details" class="mt-4">
                <!-- Tab links -->
                <ul class="nav nav-tabs" id="editTemplateTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="edit-template-tab" data-toggle="tab" href="#template" role="tab" aria-controls="template" aria-selected="true">Template</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="edit-variables-tab" data-toggle="tab" href="#variables" role="tab" aria-controls="variables" aria-selected="false">Variables</a>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content mt-4">
                    <div class="tab-pane fade show active" id="template" role="tabpanel">
                        <form id="update_template_form" action="/update_template" method="post">
                            <input type="hidden" name="template_id" id="template_id" value="{{ template_id }}">
                            <div class="form-group">
                                <label for="template_name">Template Name:</label>
                                <input type="text" id="template_name" name="template_name" class="form-control" value="{{ template_name }}">
                            </div>
                            <div class="form-group">
                                <label for="template_content">Template Content:</label>
                                <textarea name="template_content" id="template_content" class="form-control">{{ template_content }}</textarea>
                            </div>
                            <input type="submit" name="update_template" value="Update template" class="btn btn-primary">
                        </form>
                    </div>
                    <div class="tab-pane fade" id="variables" role="tabpanel">
                        <h4>Existing Variables:</h4>
                        <div>
                            {% for variable in variables %}
                                <span class="variable-button btn btn-light">{{ variable }}
                                    <button type="button" class="btn text-danger btn-sm delete-variable" data-variable="{{ variable }}">X</button>
                                </span>
                            {% endfor %}
                        </div>
                        <!-- Existing Add New Variable form in edit_template.html -->
                        <h4 class="mt-4">Add New Variable:</h4>
                        <form action="/add_variable" method="post" id="add_variable_form">
                            <!-- Add this line to include the template_id -->
                            <input type="hidden" name="template_id" value="{{ template_id }}">
                            <div class="form-group">
                                <input type="text" name="variable_name" class="form-control" id="variable_name" placeholder="Enter variable e.g. [name]">
                            </div>
                            <input type="submit" name="add_variable" value="Add Variable" class="btn btn-secondary">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.ckeditor.com/4.16.0/full/ckeditor.js"></script>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function(){
        // Initialize CKEditor
        CKEDITOR.replace('template_content', {
            removePlugins: 'exportpdf',
            extraPlugins: 'insertVariable',
            toolbar: [
                ['InsertVariable'],
                ['Bold', 'Italic', 'Underline', 'Strike'],
                ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent'],
                ['Font', 'FontSize', 'TextColor', 'BGColor'],
                ['Undo', 'Redo']
            ]
        });

        // Custom CKEditor Plugin for inserting variables
        CKEDITOR.plugins.add('insertVariable', {
            init: function(editor) {
                editor.ui.addRichCombo('InsertVariable', {
                    className: 'cke_button__insertvariable_label',
                    label: '+ Variable',
                    title: '+ Add variable',
                    toolbar: 'insert',
                    panel: {
                        css: [ CKEDITOR.skin.getPath('editor') ].concat(editor.config.contentsCss),
                        multiSelect: false,
                        attributes: { 'aria-label': 'Variables' }
                    },
                    init: function() {
                        var variables = {{ variables|tojson }};
                        for(var i = 0; i < variables.length; i++) {
                            this.add(variables[i], variables[i], variables[i]);
                        }
                    },
                    onClick: function(value) {
                        editor.insertText(value);
                    }
                });
            }
        });

        // AJAX call to add a variable
        $("#add_variable_form").submit(function(event) {
            event.preventDefault();
            var variableName = $("#variable_name").val();
            var templateID = $("#template_id").val();
            
            $.ajax({
                url: '/add_variable',
                type: 'POST',
                data: { variable_name: variableName, template_id: templateID },
                success: function(response) {
                    if (response.status === 'success') {
                        $(".variable-button:last").after(`<span class="variable-button btn btn-light">${variableName} <button type="button" class="btn text-danger btn-sm delete-variable" data-variable="${variableName}">X</button></span>`);
                        localStorage.setItem('activeTab', '#variables');
                        $('.nav-tabs a[href="#variables"]').tab('show');
                    } else {
                        $("#flash-messages").append(`<div class="alert alert-warning" role="alert">${response.message}</div>`);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#flash-messages").append(`<div class="alert alert-danger" role="alert">AJAX Error: ${textStatus}, ${errorThrown}</div>`);
                }
            });
        });
  
        
        // AJAX code to submit the form:
        $("#update_template_form").submit(function(event) {
            event.preventDefault();
            var formData = $(this).serialize();
            
            $.ajax({
                url: '/update_template',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        $("#flash-messages").append(`<div class="alert alert-success" role="alert">${response.message}</div>`);
                    } else {
                        $("#flash-messages").append(`<div class="alert alert-warning" role="alert">${response.message}</div>`);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#flash-messages").append(`<div class="alert alert-danger" role="alert">AJAX Error: ${textStatus}, ${errorThrown}</div>`);
                }
            });
        });

  
        // AJAX call to delete a variable
        $(document).on('click', '.delete-variable', function() {
            let variableToDelete = $(this).data('variable');
            var templateID = $("#template_id").val();

            $.ajax({
                url: '/delete_variable',
                type: 'POST',
                data: { variable_name: variableToDelete, template_id: templateID },
                success: function(response) {
                    if (response.status === 'success') {
                        $('span.variable-button:contains(' + variableToDelete + ')').remove();
                    } else {
                        console.error("Failed to delete variable:", response.message);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error:", textStatus, errorThrown);
                }
            });
        });
        
        // Local storage for tab persistence
        $("#add_variable_form").on('submit', function(e) {
            localStorage.setItem('activeTab', '#variables');
        });

        let activeTab = localStorage.getItem('activeTab');
        if(activeTab){
            $('.nav-tabs a[href="' + activeTab + '"]').tab('show');
        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            localStorage.setItem('activeTab', $(e.target).attr('href'));
        });
    });
</script>
{% endblock %}